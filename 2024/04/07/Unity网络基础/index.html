<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Unity网络基础 | 紫地丁的个人博客</title><meta name="author" content="紫地丁"><meta name="copyright" content="紫地丁"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="游戏开发中的网络技术">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity网络基础">
<meta property="og:url" content="https://purpleditine.top/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="紫地丁的个人博客">
<meta property="og:description" content="游戏开发中的网络技术">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://purpleditine.top/img/internet.jpg">
<meta property="article:published_time" content="2024-04-07T03:36:07.000Z">
<meta property="article:modified_time" content="2024-04-22T14:41:08.306Z">
<meta property="article:author" content="紫地丁">
<meta property="article:tag" content="unity">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://purpleditine.top/img/internet.jpg"><link rel="shortcut icon" href="/img/head-small.png"><link rel="canonical" href="https://purpleditine.top/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Unity网络基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-22 22:41:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">34</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/internet.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="紫地丁的个人博客"><span class="site-name">紫地丁的个人博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Unity网络基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-07T03:36:07.000Z" title="发表于 2024-04-07 11:36:07">2024-04-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-22T14:41:08.306Z" title="更新于 2024-04-22 22:41:08">2024-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Unity网络基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h2><p>如果有两个处于局域网中的设备,怎么将信息准确的从一台设备传递给另一台设备?</p>
<p>IP地址是一种统一的地址格式,是设备在网络中的具体地址</p>
<h3 id="按协议分类"><a href="#按协议分类" class="headerlink" title="按协议分类"></a>按协议分类</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320142504849.png" alt="image-20240320142504849"></p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320142511501.png" alt="image-20240320142511501"></p>
<blockquote>
<p>IPv6可以为世界上的每一粒沙子定义IP地址</p>
</blockquote>
<h3 id="按使用范围分类"><a href="#按使用范围分类" class="headerlink" title="按使用范围分类"></a>按使用范围分类</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320143029288.png" alt="image-20240320143029288"></p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320143315292.png" alt="image-20240320143315292"></p>
<h2 id="端口号"><a href="#端口号" class="headerlink" title="端口号"></a>端口号</h2><p>端口号用来区分设备的应用程序</p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320143759413.png" alt="image-20240320143759413"></p>
<h2 id="Mac地址"><a href="#Mac地址" class="headerlink" title="Mac地址"></a>Mac地址</h2><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320144315245.png" alt="image-20240320144315245"></p>
<p> <img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320144739799.png" alt="image-20240320144739799"></p>
<h1 id="客户端和服务端"><a href="#客户端和服务端" class="headerlink" title="客户端和服务端"></a>客户端和服务端</h1><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>即用户使用的设备,泛指客户端应用程序</p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320145347621.png" alt="image-20240320145347621"></p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320145433626.png" alt="image-20240320145433626"></p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320145503082.png" alt="image-20240320145503082"></p>
<h1 id="数据通信模型"><a href="#数据通信模型" class="headerlink" title="数据通信模型"></a>数据通信模型</h1><h2 id="数据通信模型-1"><a href="#数据通信模型-1" class="headerlink" title="数据通信模型"></a>数据通信模型</h2><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320150806315.png" alt="image-20240320150806315"></p>
<h3 id="分散式"><a href="#分散式" class="headerlink" title="分散式"></a>分散式</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320150839910.png" alt="image-20240320150839910"></p>
<h3 id="集中式"><a href="#集中式" class="headerlink" title="集中式"></a>集中式</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320151001904.png" alt="image-20240320151001904"></p>
<h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320151159639.png" alt="image-20240320151159639"></p>
<h2 id="C-x2F-S模型"><a href="#C-x2F-S模型" class="headerlink" title="C&#x2F;S模型"></a>C&#x2F;S模型</h2><p>即client&#x2F;server</p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320151348272.png" alt="image-20240320151348272"></p>
<h2 id="B-x2F-S模型"><a href="#B-x2F-S模型" class="headerlink" title="B&#x2F;S模型"></a>B&#x2F;S模型</h2><p>即browse&#x2F;server</p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320151417675.png" alt="image-20240320151417675"></p>
<h2 id="P2P模型"><a href="#P2P模型" class="headerlink" title="P2P模型"></a>P2P模型</h2><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320151604276.png" alt="image-20240320151604276"></p>
<h1 id="网络协议概述"><a href="#网络协议概述" class="headerlink" title="网络协议概述"></a>网络协议概述</h1><p> <img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320153304127.png" alt="image-20240320153304127"></p>
<h1 id="OSI模型"><a href="#OSI模型" class="headerlink" title="OSI模型"></a>OSI模型</h1><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320153539347.png" alt="image-20240320153539347"></p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320153828636.png" alt="image-20240320153828636"></p>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320154024476.png" alt="image-20240320154024476"></p>
<h2 id="OSI各层的作用"><a href="#OSI各层的作用" class="headerlink" title="OSI各层的作用"></a>OSI各层的作用</h2><h3 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320154641171.png" alt="image-20240320154641171"></p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320154707656.png" alt="image-20240320154707656"></p>
<h3 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320154916069.png" alt="image-20240320154916069"></p>
<h3 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320155113948.png" alt="image-20240320155113948"></p>
<h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320155536350.png" alt="image-20240320155536350"></p>
<h3 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320155701690.png" alt="image-20240320155701690"></p>
<h3 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h3><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320155907005.png" alt="image-20240320155907005"></p>
<hr>
<p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240320160023188.png" alt="image-20240320160023188"></p>
<h1 id="TCP-x2F-IP协议"><a href="#TCP-x2F-IP协议" class="headerlink" title="TCP&#x2F;IP协议"></a>TCP&#x2F;IP协议</h1><p><img src="https://tuchuange.oss-cn-beijing.aliyuncs.com/img/image-20240321160805849.png" alt="image-20240321160805849"></p>
<h2 id="TCP-x2F-IP协议的规则"><a href="#TCP-x2F-IP协议的规则" class="headerlink" title="TCP&#x2F;IP协议的规则"></a>TCP&#x2F;IP协议的规则</h2><p>TCP&#x2F;IP基于OSI设计</p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321161006911.png" alt="image-20240321161006911"></p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321161508007.png" alt="image-20240321161508007"></p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321161552000.png" alt="image-20240321161552000"></p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321162251466.png" alt="image-20240321162251466"></p>
<h1 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a>TCP和UDP</h1><p>TCP:传输控制协议</p>
<p>UDP:用户数据报协议</p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321162355407.png" alt="image-20240321162355407"></p>
<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321162518320.png" alt="image-20240321162518320"></p>
<p>“三次握手”建立连接,”四次挥手”断开连接</p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321162622401.png" alt="image-20240321162622401"></p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321162806748.png" alt="image-20240321162806748"></p>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321163131212.png" alt="image-20240321163131212"></p>
<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321163231917.png" alt="image-20240321163231917"></p>
<h1 id="网络游戏通信方案概述"><a href="#网络游戏通信方案概述" class="headerlink" title="网络游戏通信方案概述"></a>网络游戏通信方案概述</h1><h2 id="弱联网和强联网"><a href="#弱联网和强联网" class="headerlink" title="弱联网和强联网"></a>弱联网和强联网</h2><p>弱联网:游戏不会频繁的进行数据通信,客户端和服务端之间每次连接只处理一次请求</p>
<p>强联网:游戏会频繁的和服务端进行通信,会一直和服务端保持连接状态,不停的交换数据</p>
<h2 id="长连接和短连接"><a href="#长连接和短连接" class="headerlink" title="长连接和短连接"></a>长连接和短连接</h2><p>按照网络游戏通信特点划分</p>
<p><strong>短连接</strong></p>
<p>通信方式:HTTP,HTTPS(本质上是TCP)</p>
<p><strong>长连接</strong></p>
<p>通信方式:TCP,UDP</p>
<h2 id="Socket-HTTP-FTP"><a href="#Socket-HTTP-FTP" class="headerlink" title="Socket,HTTP,FTP"></a>Socket,HTTP,FTP</h2><h3 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h3><p>网络套接字,是对网络中不同主机上应用进程之间进行双向通信的端点的抽象</p>
<p>主要用来完成长连接</p>
<h3 id="HTTP-x2F-HTTPS"><a href="#HTTP-x2F-HTTPS" class="headerlink" title="HTTP&#x2F;HTTPS"></a>HTTP&#x2F;HTTPS</h3><p>超文本传输协议</p>
<p>主要用来完成短连接</p>
<h3 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h3><p>文件传输协议</p>
<p>主要用来完成文件的上传和下载</p>
<h1 id="IP地址和端口类"><a href="#IP地址和端口类" class="headerlink" title="IP地址和端口类"></a>IP地址和端口类</h1><h2 id="IPAddress类"><a href="#IPAddress类" class="headerlink" title="IPAddress类"></a>IPAddress类</h2><p>使用byte数组进行初始化</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[] ipAddress = <span class="keyword">new</span> <span class="built_in">byte</span>[] &#123; <span class="number">118</span>, <span class="number">102</span>, <span class="number">111</span>, <span class="number">11</span> &#125;;</span><br><span class="line">IPAddress ip1 = <span class="keyword">new</span> IPAddress(ipAddress);</span><br></pre></td></tr></table></figure>

<p>使用long初始化</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPAddress ip2 = <span class="keyword">new</span> IPAddress(<span class="number">0x79666F0B</span>);</span><br></pre></td></tr></table></figure>

<p>推荐初始化方式,字符串转换</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPAddress ip3 = IPAddress.Parse(<span class="string">&quot;118,102.111.11&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>特殊ip地址:127.0.0.1 代表本机地址</p>
<h2 id="IPEndPoint类"><a href="#IPEndPoint类" class="headerlink" title="IPEndPoint类"></a>IPEndPoint类</h2><p>IPEndPoint表现为ip地址和端口号的组合</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(ip3,<span class="number">8008</span>);</span><br></pre></td></tr></table></figure>

<h1 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h1><h2 id="什么是域名解析"><a href="#什么是域名解析" class="headerlink" title="什么是域名解析"></a>什么是域名解析</h2><p>将域名解析成ip</p>
<p>为了方便记忆,采用域名标识站点地址</p>
<p>域名的解析工作由DNS(域名系统)服务器完成</p>
<h2 id="IPHostEntry类"><a href="#IPHostEntry类" class="headerlink" title="IPHostEntry类"></a>IPHostEntry类</h2><p>域名解析后的返回值,用来获取ip地址,主机名等信息</p>
<p>该类不会自己声明,都是作为某些方法返回值返回信息</p>
<h2 id="DNS类"><a href="#DNS类" class="headerlink" title="DNS类"></a>DNS类</h2><p>一个静态类,可以使用它根据域名获取ip地址</p>
<p>获取本机系统的主机名</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFCLog.Info(Dns.GetHostName());</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[PFC_Info]:LAPTOP-EKSLMM8U</span><br></pre></td></tr></table></figure>

<p>获取指定域名可的ip信息</p>
<p>由于获取远程主机信息需要进行网络通信,所以可能会阻塞主线程</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IPHostEntry entry = Dns.GetHostEntry(<span class="string">&quot;www.purpleditine.top&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> entry.AddressList)</span><br><span class="line">&#123;</span><br><span class="line">    PFCLog.Info(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\hanfe\AppData\Roaming\Typora\typora-user-images\image-20240321202603694.png" alt="image-20240321202603694"></p>
<p>异步获取</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">GetHostEntry</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Task&lt;IPHostEntry&gt; task = Dns.GetHostEntryAsync(<span class="string">&quot;www.purpleditine.top&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> task;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> task.Result.AddressList)</span><br><span class="line">    &#123;</span><br><span class="line">        PFCLog.Info(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="序列化和反序列化二进制数据"><a href="#序列化和反序列化二进制数据" class="headerlink" title="序列化和反序列化二进制数据"></a>序列化和反序列化二进制数据</h1><h2 id="网络通信中传输的数据"><a href="#网络通信中传输的数据" class="headerlink" title="网络通信中传输的数据"></a>网络通信中传输的数据</h2><p>网络通信中传输的是二进制数据,所以我们需要将类对象信息序列化为二进制数据(一般为byte字节数组)</p>
<p> 我们以前在C#中使用BinaryFormatter类将C#类转换为字节数组,但在此处我们不使用这种办法,因为BinaryFormatter不兼容其他语言,而客户端和服务端的语言大多数时候是不同的</p>
<h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>如果不使用BinaryFormatter,将类对象转换为二进制就需要我们自己处理</p>
<p>首先,我们需要明确字节数组的容量</p>
<p>对象中出现了string类型的变量,所以当我们传输数据的时候,要在string数据之前传输string的长度</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> lev;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> name;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">short</span> atk;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于以上这个类,其对象内存应占用4+4(name长度)+name长度+2+1</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">Class2Byte</span>(<span class="params">PlayerInfo info</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> byteLength = <span class="keyword">sizeof</span>(<span class="built_in">int</span>) + <span class="keyword">sizeof</span>(<span class="built_in">int</span>) +</span><br><span class="line">                     Encoding.UTF8.GetBytes(info.name).Length +</span><br><span class="line">                     <span class="keyword">sizeof</span>(<span class="built_in">short</span>) + <span class="keyword">sizeof</span>(<span class="built_in">bool</span>);</span><br><span class="line">    <span class="built_in">byte</span>[] playerBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[byteLength];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BitConverter.GetBytes(info.lev).CopyTo(playerBytes,index);</span><br><span class="line">    index += <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">byte</span>[] strBytes = Encoding.UTF8.GetBytes(info.name);</span><br><span class="line">    <span class="built_in">int</span> num = strBytes.Length;</span><br><span class="line">    BitConverter.GetBytes(num).CopyTo(playerBytes,index);</span><br><span class="line">    index += <span class="number">4</span>;</span><br><span class="line">    strBytes.CopyTo(playerBytes,index);</span><br><span class="line">    index += num;</span><br><span class="line">    </span><br><span class="line">    BitConverter.GetBytes(info.atk).CopyTo(playerBytes,index);</span><br><span class="line">    index += <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    BitConverter.GetBytes(info.sex).CopyTo(playerBytes,index);</span><br><span class="line">    index += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> playerBytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化同理</p>
<p>我们写一个数据基类来方便数据的序列化和反序列化</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NetLearn.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 序列化</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">int</span> <span class="title">GetBytesNum</span>()</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">byte</span>[] <span class="title">Writing</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteInt</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">int</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes,index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteShort</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">short</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes,index);</span><br><span class="line">            index += <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLong</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">long</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes,index);</span><br><span class="line">            index += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteFloat</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">float</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes,index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteByte</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">byte</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            bytes[index] = <span class="keyword">value</span>;</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteBool</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">bool</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BitConverter.GetBytes(<span class="keyword">value</span>).CopyTo(bytes,index);</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteString</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">string</span> <span class="keyword">value</span> ,<span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] strBytes = Encoding.UTF8.GetBytes(<span class="keyword">value</span>);</span><br><span class="line">            WriteInt(bytes,strBytes.Length,<span class="keyword">ref</span> index);</span><br><span class="line">            strBytes.CopyTo(bytes,index);</span><br><span class="line">            index += strBytes.Length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteData</span>(<span class="params"><span class="built_in">byte</span>[] bytes, BaseData <span class="keyword">value</span>, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">value</span>.Writing().CopyTo(bytes,index);</span><br><span class="line">            index += <span class="keyword">value</span>.GetBytesNum();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">int</span> <span class="title">Reading</span>(<span class="params"><span class="built_in">byte</span>[] bytes,<span class="built_in">int</span> beginIndex = <span class="number">0</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">int</span> <span class="title">ReadInt</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> <span class="keyword">value</span> = BitConverter.ToInt32(bytes, index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">short</span> <span class="title">ReadShort</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">short</span> <span class="keyword">value</span> = BitConverter.ToInt16(bytes, index);</span><br><span class="line">            index += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">long</span> <span class="title">ReadLong</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">long</span> <span class="keyword">value</span> = BitConverter.ToInt64(bytes, index);</span><br><span class="line">            index += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">float</span> <span class="title">ReadSingle</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> <span class="keyword">value</span> = BitConverter.ToSingle(bytes, index);</span><br><span class="line">            index += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">byte</span> <span class="title">ReadByte</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">byte</span> <span class="keyword">value</span> = bytes[index];</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">ReadBool</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">bool</span> <span class="keyword">value</span> = BitConverter.ToBoolean(bytes, index);</span><br><span class="line">            index += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">ReadString</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">int</span> length = ReadInt(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="built_in">string</span> <span class="keyword">value</span> = Encoding.UTF8.GetString(bytes, index, length);</span><br><span class="line">            index += length;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> T <span class="title">ReadData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="keyword">ref</span> <span class="built_in">int</span> index</span>) <span class="keyword">where</span> T : BaseData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            T <span class="keyword">value</span> = <span class="keyword">new</span> T();</span><br><span class="line">            index += <span class="keyword">value</span>.Reading(bytes,index);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NetLearn.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestInfo</span> : <span class="title">BaseData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">short</span> lev;</span><br><span class="line">        <span class="keyword">public</span> PlayerInfo p;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> hp;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> name;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> sex;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetBytesNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span> + p.GetBytesNum() + <span class="number">4</span> + <span class="number">4</span> +</span><br><span class="line">                   Encoding.UTF8.GetBytes(name).Length + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">byte</span>[] <span class="title">Writing</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[GetBytesNum()];</span><br><span class="line">            WriteShort(bytes,lev,<span class="keyword">ref</span> index);</span><br><span class="line">            WriteData(bytes,p,<span class="keyword">ref</span> index);</span><br><span class="line">            WriteInt(bytes,hp,<span class="keyword">ref</span> index);</span><br><span class="line">            WriteString(bytes,name,<span class="keyword">ref</span> index);</span><br><span class="line">            WriteBool(bytes,sex,<span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">Reading</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="built_in">int</span> beginIndex = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = beginIndex;</span><br><span class="line">            lev = ReadShort(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            p = ReadData&lt;PlayerInfo&gt;(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            hp = ReadInt(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            name = ReadString(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            sex = ReadBool(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">return</span> index - beginIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerInfo</span> : <span class="title">BaseData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> atk;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetBytesNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">byte</span>[] <span class="title">Writing</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[GetBytesNum()];</span><br><span class="line">            WriteInt(bytes, atk, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">Reading</span>(<span class="params"><span class="built_in">byte</span>[] bytes, <span class="built_in">int</span> beginIndex = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = beginIndex;</span><br><span class="line">            atk = ReadInt(bytes, <span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">return</span> index -= beginIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">TestInfo info = <span class="keyword">new</span> TestInfo();</span><br><span class="line">info.lev = <span class="number">87</span>;</span><br><span class="line">info.p = <span class="keyword">new</span> Data.PlayerInfo();</span><br><span class="line">info.p.atk = <span class="number">11</span>;</span><br><span class="line">info.hp = <span class="number">111</span>;</span><br><span class="line">info.name = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">info.sex = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">byte</span>[] infoByte = info.Writing();</span><br><span class="line">TestInfo info2 = <span class="keyword">new</span>();</span><br><span class="line">info2.Reading(infoByte);</span><br><span class="line">print(info2.lev);</span><br><span class="line">print(info2.p.atk);</span><br><span class="line">print(info2.name);</span><br></pre></td></tr></table></figure>

<h1 id="Socket的重要API"><a href="#Socket的重要API" class="headerlink" title="Socket的重要API"></a>Socket的重要API</h1><h2 id="Socket的作用"><a href="#Socket的作用" class="headerlink" title="Socket的作用"></a>Socket的作用</h2><p>Socket是C#提供的用于网络通讯的类,其他语言也有对应的概念</p>
<p>是支持TCP&#x2F;IP网络通信的基本操作单位</p>
<p>可以被视为一个通道,连接于客户端与服务端,数据的发送和接受均通过这个通道</p>
<h2 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h2><h3 id="流套接字"><a href="#流套接字" class="headerlink" title="流套接字"></a>流套接字</h3><p>用于实现TCP通信</p>
<h3 id="数据报套接字"><a href="#数据报套接字" class="headerlink" title="数据报套接字"></a>数据报套接字</h3><p>用于实现UDP通信</p>
<h3 id="原始套接字"><a href="#原始套接字" class="headerlink" title="原始套接字"></a>原始套接字</h3><hr>
<p>我们使用Socket的构造函数声明不同的套接字</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Socket socketTcp = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork,SocketType.Stream,ProtocolType.Tcp);</span><br><span class="line">Socket socketUdp = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork,SocketType.Dgram,ProtocolType.Udp);</span><br></pre></td></tr></table></figure>

<h2 id="常用属性"><a href="#常用属性" class="headerlink" title="常用属性"></a>常用属性</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//套接字的连接状态</span></span><br><span class="line">         PFCLog.Info(socketTcp.Connected);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//套接字类型</span></span><br><span class="line">         PFCLog.Info(socketTcp.SocketType);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//协议类型</span></span><br><span class="line">         PFCLog.Info(socketTcp.ProtocolType);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//寻址方案</span></span><br><span class="line">         PFCLog.Info(socketTcp.AddressFamily);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//从网络中获取准备读取的数据量</span></span><br><span class="line">         PFCLog.Info(socketTcp.Available);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//获取本机EndPoint对象</span></span><br><span class="line">         <span class="comment">//socketTcp.LocalEndPoint as IPEndPoint;</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">//获取远程EndPoint对象</span></span><br><span class="line">         <span class="comment">//socketTcp.RemoteEndPoint as IPEndPoint;</span></span><br></pre></td></tr></table></figure>

<h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><h3 id="常用于服务端"><a href="#常用于服务端" class="headerlink" title="常用于服务端"></a>常用于服务端</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//绑定ip和端口</span></span><br><span class="line">         IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">8080</span>);</span><br><span class="line">         socketTcp.Bind(ipPoint);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//设置客户端连接的最大数量</span></span><br><span class="line">         socketTcp.Listen(<span class="number">10</span>);</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//等待客户端连入</span></span><br><span class="line">         socketTcp.Accept();</span><br></pre></td></tr></table></figure>

<h3 id="常用语客户端"><a href="#常用语客户端" class="headerlink" title="常用语客户端"></a>常用语客户端</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socketTcp.Connect(ipPoint);</span><br></pre></td></tr></table></figure>

<h3 id="常用于服务端和客户端"><a href="#常用于服务端和客户端" class="headerlink" title="常用于服务端和客户端"></a>常用于服务端和客户端</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//socketTcp.Send(something);</span></span><br><span class="line">         socketTcp.Shutdown(SocketShutdown.Both);</span><br><span class="line">         socketTcp.Close();</span><br></pre></td></tr></table></figure>

<h1 id="Socket套接字TCP通信概述"><a href="#Socket套接字TCP通信概述" class="headerlink" title="Socket套接字TCP通信概述"></a>Socket套接字TCP通信概述</h1><h2 id="服务端和客户端需要做什么"><a href="#服务端和客户端需要做什么" class="headerlink" title="服务端和客户端需要做什么"></a>服务端和客户端需要做什么</h2><h3 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h3><ol>
<li>创建Socket</li>
<li>用Bind方法将套接字与本地地址绑定</li>
<li>用Listen监听</li>
<li>用Accept方法等待客服端连接</li>
<li>建立连接,Accept返回新套接字</li>
<li>用Send和Receive相关方法发送数据</li>
<li>用shutdown释放连接</li>
<li>关闭套接字</li>
</ol>
<h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><ol>
<li>创建Socket</li>
<li>用Connect方法与服务端连接</li>
<li>用Send和Receive相关方法发送数据</li>
<li>用shutdown释放连接</li>
<li>关闭套接字</li>
</ol>
<h1 id="服务端-2"><a href="#服务端-2" class="headerlink" title="服务端"></a>服务端</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServerLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Server</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Socket socketTcp = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">8080</span>);</span><br><span class="line">                socketTcp.Bind(ipPoint);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            socketTcp.Listen(<span class="number">1024</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;服务端绑定监听结束,等待客户端&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Socket socketClinet = socketTcp.Accept();</span><br><span class="line"></span><br><span class="line">            socketClinet.Send(Encoding.UTF8.GetBytes(<span class="string">&quot;欢迎连入服务端&quot;</span>));</span><br><span class="line">            <span class="built_in">byte</span>[] result = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">int</span> receiveNum = socketClinet.Receive(result);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;接收到了<span class="subst">&#123;socketClinet.RemoteEndPoint.ToString&#125;</span>发来的消息:<span class="subst">&#123;Encoding.UTF8.GetString(result, <span class="number">0</span>, receiveNum)&#125;</span>&quot;</span>);</span><br><span class="line">            socketClinet.Shutdown(SocketShutdown.Both);</span><br><span class="line">            socketClinet.Close();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="客户端-2"><a href="#客户端-2" class="headerlink" title="客户端"></a>客户端</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> PurpleFlowerCore;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NetLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lesson6</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Socket socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>),<span class="number">8080</span>);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                socket.Connect(ipPoint);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SocketException e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(e.ErrorCode <span class="keyword">is</span> <span class="number">10061</span>)</span><br><span class="line">                    PFCLog.Info(<span class="string">&quot;服务器拒绝连接&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    PFCLog.Info(<span class="string">&quot;连接失败:&quot;</span>+e.ErrorCode);</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">byte</span>[] receiveBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">int</span> receiveNum =  socket.Receive(receiveBytes);</span><br><span class="line">            PFCLog.Info(<span class="string">&quot;收到服务端发来的消息&quot;</span>+Encoding.UTF8.GetString(receiveBytes,<span class="number">0</span>,receiveNum));</span><br><span class="line">            socket.Send(Encoding.UTF8.GetBytes(<span class="string">&quot;你好,我是一个客户端&quot;</span>));</span><br><span class="line">            socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">            socket.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="服务端综合练习"><a href="#服务端综合练习" class="headerlink" title="服务端综合练习"></a>服务端综合练习</h1><p>我们需要实现服务端与多个客户端连接</p>
<p>Accept方法是可以多次调用的,且为阻塞方法,所以我们可以专门开一个线程负责客户端的连接</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AcceptClientConnect</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Socket clientSocket = _socket.Accept();</span><br><span class="line">        _clientSockets.Add(clientSocket);</span><br><span class="line">        clientSocket.Send(Encoding.UTF8.GetBytes(<span class="string">&quot;欢迎连入服务端&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理,我们还需要一个线程管理接收消息,如果服务端接收了一个客户端的消息,又需要一个线程来处理消息,此时我们可以使用线程池</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReceiveMsg</span>()</span> </span><br><span class="line">&#123;</span><br><span class="line">    Socket clientSocket;</span><br><span class="line">    <span class="built_in">int</span> receiveNum;</span><br><span class="line">    <span class="built_in">byte</span>[] result = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">int</span> i;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; _clientSockets.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            clientSocket = _clientSockets[i];</span><br><span class="line">            <span class="keyword">if</span>(clientSocket.Available&gt;<span class="number">0</span>)</span><br><span class="line">            &#123; </span><br><span class="line">                receiveNum = clientSocket.Receive(result);</span><br><span class="line">                ThreadPool.QueueUserWorkItem(HandleMsg, (clientSocket, Encoding.UTF8.GetString(result, <span class="number">0</span>, receiveNum)));</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">HandleMsg</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    (Socket s,<span class="built_in">string</span> str) info = ((Socket s,<span class="built_in">string</span> str))obj;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;收到客户端<span class="subst">&#123;info.s.RemoteEndPoint&#125;</span>发来的消息:<span class="subst">&#123;info.str&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用这个思路,服务端如下</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServerLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Server</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Socket _socketTcp;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Socket&gt; _clientSockets = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> isClose = <span class="literal">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _socketTcp = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">8080</span>);</span><br><span class="line">                _socketTcp.Bind(ipPoint);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _socketTcp.Listen(<span class="number">1024</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;服务端绑定监听结束,等待客户端&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Thread acceptThread = <span class="keyword">new</span> Thread(AcceptClientConnect);</span><br><span class="line">            acceptThread.Start();</span><br><span class="line"></span><br><span class="line">            Thread receiveThread = <span class="keyword">new</span> Thread(ReceiveMsg);</span><br><span class="line">            receiveThread.Start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> input = Console.ReadLine();</span><br><span class="line">                <span class="keyword">if</span>(input <span class="keyword">is</span> <span class="string">&quot;Quit&quot;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    isClose = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _clientSockets.Count; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _clientSockets[i].Shutdown(SocketShutdown.Both);</span><br><span class="line">                        _clientSockets[i].Close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    _clientSockets.Clear();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(input.Substring(<span class="number">0</span>,<span class="number">2</span>) <span class="keyword">is</span> <span class="string">&quot;B:&quot;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _clientSockets.Count; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _clientSockets[i].Send(Encoding.UTF8.GetBytes(input.Substring(<span class="number">2</span>)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AcceptClientConnect</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isClose)</span><br><span class="line">            &#123;</span><br><span class="line">                Socket clientSocket = _socketTcp.Accept();</span><br><span class="line">                _clientSockets.Add(clientSocket);</span><br><span class="line">                clientSocket.Send(Encoding.UTF8.GetBytes(<span class="string">&quot;欢迎连入服务端&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReceiveMsg</span>()</span> </span><br><span class="line">        &#123;</span><br><span class="line">            Socket clientSocket;</span><br><span class="line">            <span class="built_in">int</span> receiveNum;</span><br><span class="line">            <span class="built_in">byte</span>[] result = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">int</span> i;</span><br><span class="line">            <span class="keyword">while</span> (!isClose)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; _clientSockets.Count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    clientSocket = _clientSockets[i];</span><br><span class="line">                    <span class="keyword">if</span>(clientSocket.Available&gt;<span class="number">0</span>)</span><br><span class="line">                    &#123; </span><br><span class="line">                        receiveNum = clientSocket.Receive(result);</span><br><span class="line">                        ThreadPool.QueueUserWorkItem(HandleMsg, (clientSocket, Encoding.UTF8.GetString(result, <span class="number">0</span>, receiveNum)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">HandleMsg</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            (Socket s,<span class="built_in">string</span> str) info = ((Socket s,<span class="built_in">string</span> str))obj;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;收到客户端<span class="subst">&#123;info.s.RemoteEndPoint&#125;</span>发来的消息:<span class="subst">&#123;info.str&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在,我们用面向对象思想对服务端进行封装</p>
<h2 id="ServerSocket-cs"><a href="#ServerSocket-cs" class="headerlink" title="ServerSocket.cs"></a>ServerSocket.cs</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServerLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServerSocket</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Socket _socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, ClientSocket&gt; _clinets = <span class="keyword">new</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> _isClose;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="built_in">string</span> ip,<span class="built_in">int</span> port,<span class="built_in">int</span> num</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _isClose = <span class="literal">false</span>;</span><br><span class="line">            _socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            IPEndPoint ipPoint = <span class="keyword">new</span>(IPAddress.Parse(ip), port);</span><br><span class="line">            _socket.Bind(ipPoint);</span><br><span class="line">            _socket.Listen(num);</span><br><span class="line">            ThreadPool.QueueUserWorkItem(Accept);</span><br><span class="line">            ThreadPool.QueueUserWorkItem(Receive);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Accept</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (!_isClose)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Socket clientSocket = _socket.Accept();</span><br><span class="line">                    ClientSocket client = <span class="keyword">new</span>(clientSocket);</span><br><span class="line">                    _clinets.Add(client.ID, client);</span><br><span class="line">                    client.Sent(<span class="string">&quot;欢迎连入服务器&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e.Message);</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Receive</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (!_isClose)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_clinets.Count&gt;<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line"> <span class="keyword">try</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">foreach</span> (ClientSocket client <span class="keyword">in</span> _clinets.Values)</span><br><span class="line">     &#123;</span><br><span class="line">         client.Received();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;<span class="keyword">catch</span> (Exception e) &#123; Console.WriteLine(e.Message); &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _isClose=<span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (ClientSocket client <span class="keyword">in</span> _clinets.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                client.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            _clinets.Clear();</span><br><span class="line">            _socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">            _socket.Close();</span><br><span class="line">            _socket = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BroadCast</span>(<span class="params"><span class="built_in">string</span> info</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (ClientSocket client <span class="keyword">in</span> _clinets.Values)</span><br><span class="line">            &#123;</span><br><span class="line">                client.Sent(info);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我发现当多个客户端连入,52行会报错,原因是保存客户端的字典被更改了,唐老师似乎没有发现这个问题</p>
<p>所以我加了一个try-catch以防止程序崩溃</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServerLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ClientSocket</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> CLIENT_COUNT = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> Socket _socket;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _clientID;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ID =&gt; _clientID;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClientSocket</span>(<span class="params">Socket socket</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CLIENT_COUNT++;</span><br><span class="line">            <span class="keyword">this</span>._socket = socket;</span><br><span class="line">            _clientID = CLIENT_COUNT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                _socket.Close();</span><br><span class="line">                _socket = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Sent</span>(<span class="params"><span class="built_in">string</span> info</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _socket.Send(Encoding.UTF8.GetBytes(info));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e.Message);</span><br><span class="line">                    Close();</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Received</span>()</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_socket.Available&gt;<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">byte</span>[] result = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">5</span>];</span><br><span class="line">                    <span class="built_in">int</span> receiveNum = _socket.Receive(result);</span><br><span class="line">                    ThreadPool.QueueUserWorkItem(MsgHandle, Encoding.UTF8.GetString(result, <span class="number">0</span>, receiveNum));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">                Close();</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MsgHandle</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> str = obj <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;收到客户端<span class="subst">&#123;_socket.RemoteEndPoint&#125;</span>发来的消息:<span class="subst">&#123;str&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="客户端综合练习"><a href="#客户端综合练习" class="headerlink" title="客户端综合练习"></a>客户端综合练习</h1><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> PurpleFlowerCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NetLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetManager</span> : <span class="title">Singleton</span>&lt;<span class="title">NetManager</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Socket _socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Queue&lt;<span class="built_in">string</span>&gt; _sendMessages = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">private</span> Queue&lt;<span class="built_in">string</span>&gt; _receiveMessages = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">private</span> Thread _sendThread;</span><br><span class="line">        <span class="keyword">private</span> Thread _receiveThread;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">byte</span>[] _receiveBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _receiveNum;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> _isConnected;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Connect</span>(<span class="params"><span class="built_in">string</span> ip, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_isConnected) <span class="keyword">return</span>;</span><br><span class="line">            _isConnected = <span class="literal">true</span>;</span><br><span class="line">            _socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Connect(ipPoint);</span><br><span class="line">                _sendThread = <span class="keyword">new</span>(SendMessage);</span><br><span class="line">                _receiveThread = <span class="keyword">new</span>(ReceiveMessage);</span><br><span class="line">                _sendThread.Start();</span><br><span class="line">                _receiveThread.Start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SocketException e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.ErrorCode == <span class="number">10061</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    PFCLog.Info(<span class="string">&quot;服务器拒绝连接&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Console.WriteLine(e);</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Send</span>(<span class="params"><span class="built_in">string</span> info</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _sendMessages.Enqueue(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Receive</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_receiveMessages.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//处理消息</span></span><br><span class="line">                PFCLog.Info(_receiveMessages.Dequeue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (_isConnected)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_sendMessages.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _socket.Send(Encoding.UTF8.GetBytes(_sendMessages.Dequeue()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (_isConnected)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_socket.Available &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                _receiveNum = _socket.Receive(_receiveBytes);</span><br><span class="line">                _receiveMessages.Enqueue(Encoding.UTF8.GetString(_receiveBytes,<span class="number">0</span>,_receiveNum));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _isConnected = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                _socket.Close();</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        ~NetManager()</span><br><span class="line">        &#123;</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="区分消息类型"><a href="#区分消息类型" class="headerlink" title="区分消息类型"></a>区分消息类型</h1><p>我们之前发送的消息都是string,这显然不够。现在,我们要区分消息的类型。</p>
<p>比如，我们要发送类对象数据，就可以使用<a href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE">上文</a>所写的数据类,问题在于,另一端如何知道我们发送的具体是什么类型的对象</p>
<h2 id="如何区分消息"><a href="#如何区分消息" class="headerlink" title="如何区分消息"></a>如何区分消息</h2><p>我们可以给消息添加一个标识,比如在所有消息的头部添加一个消息id,然后消息的接收方先检查消息的id,根据id区分消息</p>
<hr>
<p>现在我们修改此前写的客户端的NetManager和服务端的ClientSocket</p>
<h3 id="NetManager"><a href="#NetManager" class="headerlink" title="NetManager"></a>NetManager</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> NetLearn.Data;</span><br><span class="line"><span class="keyword">using</span> PurpleFlowerCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NetLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetManager</span> : <span class="title">Singleton</span>&lt;<span class="title">NetManager</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Socket _socket;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Queue&lt;BaseMsg&gt; _sendMessages = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">private</span> Queue&lt;BaseMsg&gt; _receiveMessages = <span class="keyword">new</span>();</span><br><span class="line">        <span class="keyword">private</span> Thread _sendThread;</span><br><span class="line">        <span class="keyword">private</span> Thread _receiveThread;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">byte</span>[] _receiveBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _receiveNum;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> _isConnected;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Connect</span>(<span class="params"><span class="built_in">string</span> ip, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_isConnected) <span class="keyword">return</span>;</span><br><span class="line">            _isConnected = <span class="literal">true</span>;</span><br><span class="line">            _socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">            IPEndPoint ipPoint = <span class="keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Connect(ipPoint);</span><br><span class="line">                _sendThread = <span class="keyword">new</span>(SendMessage);</span><br><span class="line">                _receiveThread = <span class="keyword">new</span>(ReceiveMessage);</span><br><span class="line">                _sendThread.Start();</span><br><span class="line">                _receiveThread.Start();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SocketException e)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.ErrorCode == <span class="number">10061</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    PFCLog.Warning(<span class="string">&quot;服务器拒绝连接&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Console.WriteLine(e);</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Send</span>(<span class="params">BaseMsg info</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _sendMessages.Enqueue(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Receive</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_receiveMessages.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BaseMsg msg = _receiveMessages.Dequeue();</span><br><span class="line">                <span class="keyword">if</span> (msg <span class="keyword">is</span> TestMsg1)</span><br><span class="line">                &#123;</span><br><span class="line">                    TestMsg1 testMsg1 = msg <span class="keyword">as</span> TestMsg1;</span><br><span class="line">                    PFCLog.Info(<span class="string">&quot;收到消息:&quot;</span>+testMsg1.info.atk);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SendMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (_isConnected)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_sendMessages.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _socket.Send(_sendMessages.Dequeue().Writing());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (_isConnected)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_socket.Available &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                _receiveNum = _socket.Receive(_receiveBytes);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> msgID = BitConverter.ToInt32(_receiveBytes, <span class="number">0</span>);</span><br><span class="line">                BaseMsg msg = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">switch</span> (msgID)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                        msg = <span class="keyword">new</span> TestMsg1();</span><br><span class="line">                        msg.Reading(_receiveBytes, <span class="number">4</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (msg <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    PFCLog.Warning(<span class="string">&quot;未知消息:&quot;</span>+msgID);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                _receiveMessages.Enqueue(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _isConnected = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                _socket.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ~NetManager()</span><br><span class="line">        &#123;</span><br><span class="line">            Close();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ClientSocket"><a href="#ClientSocket" class="headerlink" title="ClientSocket"></a>ClientSocket</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> NetLearn.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServerLearn</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ClientSocket</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> CLIENT_COUNT = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> Socket _socket;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _clientID;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ID =&gt; _clientID;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ClientSocket</span>(<span class="params">Socket socket</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CLIENT_COUNT++;</span><br><span class="line">            <span class="keyword">this</span>._socket = socket;</span><br><span class="line">            _clientID = CLIENT_COUNT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _socket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                _socket.Close();</span><br><span class="line">                _socket = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Sent</span>(<span class="params">BaseMsg info</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(_socket <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _socket.Send(info.Writing());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e.Message);</span><br><span class="line">                    Close();</span><br><span class="line">                    <span class="keyword">throw</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Received</span>()</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_socket <span class="keyword">is</span> <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_socket.Available&gt;<span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">byte</span>[] result = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">5</span>];</span><br><span class="line">                    <span class="built_in">int</span> receiveNum = _socket.Receive(result);</span><br><span class="line">                    <span class="built_in">int</span> msgID = BitConverter.ToInt32(result, <span class="number">0</span>);</span><br><span class="line">                    BaseMsg msg = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">switch</span>(msgID)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                            msg = <span class="keyword">new</span> TestMsg1();</span><br><span class="line">                            msg.Reading(result, <span class="number">4</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(msg <span class="keyword">is</span> <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Console.WriteLine(<span class="string">&quot;未知消息:&quot;</span>+msgID);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ThreadPool.QueueUserWorkItem(MsgHandle, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">                Close();</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MsgHandle</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            BaseMsg msg = obj <span class="keyword">as</span> BaseMsg;</span><br><span class="line">            <span class="keyword">if</span>(msg <span class="keyword">is</span> TestMsg1)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;收到客户端<span class="subst">&#123;_socket.RemoteEndPoint&#125;</span>发来的消息:<span class="subst">&#123;(msg <span class="keyword">as</span> TestMsg1).info.atk&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分包、粘包"><a href="#分包、粘包" class="headerlink" title="分包、粘包"></a>分包、粘包</h1><h2 id="什么是分包和粘包"><a href="#什么是分包和粘包" class="headerlink" title="什么是分包和粘包"></a>什么是分包和粘包</h2><p>分包、粘包指网络通信中由于各种因素（网络环境、API规则）造成的消息与消息之间出现的两种状态</p>
<p>分包：一个消息分成了多个消息进行发送</p>
<p>粘包：一个消息和另一个消息黏在了一起</p>
<ul>
<li>粘包和分包可能同时发生</li>
</ul>
<h2 id="如何解决分包和粘包"><a href="#如何解决分包和粘包" class="headerlink" title="如何解决分包和粘包"></a>如何解决分包和粘包</h2><p>现在，我们没有考虑分包粘包的情况，反序列化有可能出问题</p>
<p>为了解决分包粘包，首先，我们需要判断是否发生了分包粘包，也就是判断消息的长度</p>
<p>为消息添加头部，头部记录消息的长度</p>
<p>当我们接受到消息的时候，通过长度来判断是否分包和粘包</p>
<p>对消息进行拆分合并处理，然后处理完成的消息</p>
<blockquote>
<p>我在想,如果分包或粘包的地方是消息的头部,我们现在的头部有8个字节,我们还要处理头部的分包粘包,才能处理消息的分包粘包. 那么,字节可以分包粘包吗,我的意思比如说是一次传输了4个比特,下一次传输了12个比特,这样要处理的情况就更复杂了</p>
</blockquote>
<hr>
<p>首先,我们更改此前写的TestMsg1</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">byte</span>[] <span class="title">Writing</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">byte</span>[] bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[GetBytesNum()];</span><br><span class="line">            WriteInt(bytes,GetID(),<span class="keyword">ref</span> index);</span><br><span class="line">            WriteInt(bytes,GetBytesNum()<span class="number">-8</span>,<span class="keyword">ref</span> index);<span class="comment">// 仅存储消息体的长度</span></span><br><span class="line">            WriteInt(bytes, num, <span class="keyword">ref</span> index);</span><br><span class="line">            WriteData(bytes,info,<span class="keyword">ref</span> index);</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetBytesNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span> + <span class="number">4</span> + <span class="number">4</span> + info.GetBytesNum();</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>和NetManager</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (_isConnected)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_socket.Available &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="built_in">byte</span>[] receiveBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">int</span> receiveNum = _socket.Receive(receiveBytes);</span><br><span class="line">                HandleReceiveMsg(receiveBytes,receiveNum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HandleReceiveMsg</span>(<span class="params"><span class="built_in">byte</span>[] receiveBytes,<span class="built_in">int</span> receiveNum</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> msgID = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">int</span> msgLength;</span><br><span class="line">            <span class="built_in">int</span> nowIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            receiveBytes.CopyTo(_cacheBytes,_cacheNum);</span><br><span class="line">            _cacheNum += receiveNum;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                msgLength = <span class="number">-1</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (_cacheNum -nowIndex &gt;= <span class="number">8</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    msgID = BitConverter.ToInt32(_cacheBytes, nowIndex);</span><br><span class="line">                    nowIndex += <span class="number">4</span>;</span><br><span class="line">                    msgLength = BitConverter.ToInt32(_cacheBytes, nowIndex);</span><br><span class="line">                    nowIndex += <span class="number">4</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (_cacheNum - nowIndex &gt;= msgLength&amp;&amp; msgLength!=<span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    BaseMsg msg = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">switch</span> (msgID)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">                            msg = <span class="keyword">new</span> TestMsg1();</span><br><span class="line">                            msg.Reading(_cacheBytes, nowIndex);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(msg <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">                        _receiveMessages.Enqueue(msg);</span><br><span class="line">                    nowIndex += msgLength;</span><br><span class="line">                    <span class="keyword">if</span> (nowIndex == _cacheNum)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _cacheNum = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (msgLength != <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nowIndex -= <span class="number">8</span>;</span><br><span class="line">                        Array.Copy(_cacheBytes,nowIndex,_cacheBytes,<span class="number">0</span>,_cacheNum-nowIndex);</span><br><span class="line">                        _cacheNum -= nowIndex;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure>

<h1 id="客户端主动断开连接"><a href="#客户端主动断开连接" class="headerlink" title="客户端主动断开连接"></a>客户端主动断开连接</h1><p>目前在客户端主动退出时，我们会调用socket的shutdown和close方法，但这样做服务端无法得知客户端断开连接</p>
<p>于是我们需要解决目前断开不及时的问题</p>
<p>首先，我们定义一种消息类型专门用来表示客户端断开连接，客户端发送该消息，服务端接收到该消息后，就在ServerSocket中把该客户端从字典中移除</p>
<p>注意线程安全问题</p>
<h1 id="实现心跳消息"><a href="#实现心跳消息" class="headerlink" title="实现心跳消息"></a>实现心跳消息</h1><h2 id="什么是心跳消息"><a href="#什么是心跳消息" class="headerlink" title="什么是心跳消息"></a>什么是心跳消息</h2><p>心跳消息指的是长连接中，客户端和服务端之间定期发送的一种特殊的数据包，用于通知对方自己还在线，以确保长连接的有效性</p>
<h2 id="为什么需要心跳消息"><a href="#为什么需要心跳消息" class="headerlink" title="为什么需要心跳消息"></a>为什么需要心跳消息</h2><ul>
<li><p>避免非正常关闭客户端时，服务器无法正常收到关闭连接消息</p>
</li>
<li><p>避免客户端长期不发送消息，防火墙或路由器会断开连接，我们可以通过心跳消息一直保持活跃状态</p>
</li>
</ul>
<h2 id="实现心跳消息-1"><a href="#实现心跳消息-1" class="headerlink" title="实现心跳消息"></a>实现心跳消息</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://purpleditine.top">紫地丁</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://purpleditine.top/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/">https://purpleditine.top/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://purpleditine.top" target="_blank">紫地丁的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/unity/">unity</a><a class="post-meta__tags" href="/tags/%E7%BC%96%E7%A8%8B/">编程</a><a class="post-meta__tags" href="/tags/C/">C#</a><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></div><div class="post_share"><div class="social-share" data-image="/img/internet.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/07/BlindTrust%E6%B8%B8%E6%88%8F%E4%BB%8B%E7%BB%8D/" title="BlindTrust游戏介绍"><img class="cover" src="/img/BlindTrustIcon.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">BlindTrust游戏介绍</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/07/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6/" title="Unity数据持久化-二进制学习笔记"><img class="cover" src="/img/Binary.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Unity数据持久化-二进制学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/05/08/MVC%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="MVC架构学习笔记"><img class="cover" src="/img/mvc.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-08</div><div class="title">MVC架构学习笔记</div></div></a></div><div><a href="/2023/12/14/ScriptableObject%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="ScriptableObject学习笔记"><img class="cover" src="/img/SO.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-14</div><div class="title">ScriptableObject学习笔记</div></div></a></div><div><a href="/2023/05/27/Unity-3D%E6%95%B0%E5%AD%A6/" title="Unity-3D数学基础"><img class="cover" src="/img/unityMath.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-27</div><div class="title">Unity-3D数学基础</div></div></a></div><div><a href="/2024/06/16/%E3%80%8A%E5%9F%8E%E5%B8%82%E5%8F%A0%E5%8F%A0%E4%B9%90%E3%80%8B%E4%B8%AD%E7%9A%84%E5%9F%8E%E5%B8%82%E6%98%AF%E6%80%8E%E4%B9%88%E6%90%AD%E8%B5%B7%E6%9D%A5%E7%9A%84%EF%BC%9F/" title="《城市叠叠乐》中的地图是怎么搭起来的？"><img class="cover" src="/img/WFC.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-16</div><div class="title">《城市叠叠乐》中的地图是怎么搭起来的？</div></div></a></div><div><a href="/2023/12/14/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96-Json/" title="Unity数据持久化-Json学习笔记"><img class="cover" src="/img/json.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-14</div><div class="title">Unity数据持久化-Json学习笔记</div></div></a></div><div><a href="/2024/04/07/%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6/" title="Unity数据持久化-二进制学习笔记"><img class="cover" src="/img/Binary.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-07</div><div class="title">Unity数据持久化-二进制学习笔记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">紫地丁</div><div class="author-info__description">李健豪 中国传媒大学游戏系本科在读 QQ:1146556075 微信:purpleditine     请注明来历</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">34</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/89364405?spm_id_from=333.1007.0.0"><i class="iconfont icon-bilibili"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/89364405?spm_id_from=333.999.0.0" target="_blank" title=""><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://github.com/pditine" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:hanfe666@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这里是紫地丁的个人博客，我会不定时的更新许多奇奇怪怪的作品、博文和碎碎念。总之，才疏学浅、漏洞百出、请多指教！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IP%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.</span> <span class="toc-text">IP地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E5%8D%8F%E8%AE%AE%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.1.</span> <span class="toc-text">按协议分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E4%BD%BF%E7%94%A8%E8%8C%83%E5%9B%B4%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">按使用范围分类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="toc-number">1.2.</span> <span class="toc-text">端口号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mac%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.</span> <span class="toc-text">Mac地址</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">2.</span> <span class="toc-text">客户端和服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.1.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">2.2.</span> <span class="toc-text">服务端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">数据通信模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B-1"><span class="toc-number">3.1.</span> <span class="toc-text">数据通信模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%95%A3%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">分散式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">集中式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">3.1.3.</span> <span class="toc-text">分布式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-x2F-S%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">C&#x2F;S模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B-x2F-S%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">B&#x2F;S模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#P2P%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.4.</span> <span class="toc-text">P2P模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0"><span class="toc-number">4.</span> <span class="toc-text">网络协议概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OSI%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">OSI模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OSI%E5%90%84%E5%B1%82%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">OSI各层的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E5%B1%82"><span class="toc-number">5.1.1.</span> <span class="toc-text">物理层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82"><span class="toc-number">5.2.</span> <span class="toc-text">数据链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%B1%82"><span class="toc-number">5.2.1.</span> <span class="toc-text">网络层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82"><span class="toc-number">5.2.2.</span> <span class="toc-text">传输层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82"><span class="toc-number">5.2.3.</span> <span class="toc-text">应用层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E7%A4%BA%E5%B1%82"><span class="toc-number">5.2.4.</span> <span class="toc-text">表示层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E5%B1%82"><span class="toc-number">5.2.5.</span> <span class="toc-text">会话层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP-x2F-IP%E5%8D%8F%E8%AE%AE"><span class="toc-number">6.</span> <span class="toc-text">TCP&#x2F;IP协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-x2F-IP%E5%8D%8F%E8%AE%AE%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">6.1.</span> <span class="toc-text">TCP&#x2F;IP协议的规则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TCP%E5%92%8CUDP"><span class="toc-number">7.</span> <span class="toc-text">TCP和UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP"><span class="toc-number">7.1.</span> <span class="toc-text">TCP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP"><span class="toc-number">7.2.</span> <span class="toc-text">UDP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0"><span class="toc-number">8.</span> <span class="toc-text">网络游戏通信方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%B1%E8%81%94%E7%BD%91%E5%92%8C%E5%BC%BA%E8%81%94%E7%BD%91"><span class="toc-number">8.1.</span> <span class="toc-text">弱联网和强联网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E5%92%8C%E7%9F%AD%E8%BF%9E%E6%8E%A5"><span class="toc-number">8.2.</span> <span class="toc-text">长连接和短连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket-HTTP-FTP"><span class="toc-number">8.3.</span> <span class="toc-text">Socket,HTTP,FTP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket"><span class="toc-number">8.3.1.</span> <span class="toc-text">Socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-x2F-HTTPS"><span class="toc-number">8.3.2.</span> <span class="toc-text">HTTP&#x2F;HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FTP"><span class="toc-number">8.3.3.</span> <span class="toc-text">FTP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IP%E5%9C%B0%E5%9D%80%E5%92%8C%E7%AB%AF%E5%8F%A3%E7%B1%BB"><span class="toc-number">9.</span> <span class="toc-text">IP地址和端口类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPAddress%E7%B1%BB"><span class="toc-number">9.1.</span> <span class="toc-text">IPAddress类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPEndPoint%E7%B1%BB"><span class="toc-number">9.2.</span> <span class="toc-text">IPEndPoint类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-number">10.</span> <span class="toc-text">域名解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-number">10.1.</span> <span class="toc-text">什么是域名解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPHostEntry%E7%B1%BB"><span class="toc-number">10.2.</span> <span class="toc-text">IPHostEntry类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS%E7%B1%BB"><span class="toc-number">10.3.</span> <span class="toc-text">DNS类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">11.</span> <span class="toc-text">序列化和反序列化二进制数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E4%B8%AD%E4%BC%A0%E8%BE%93%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">11.1.</span> <span class="toc-text">网络通信中传输的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">11.2.</span> <span class="toc-text">序列化与反序列化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Socket%E7%9A%84%E9%87%8D%E8%A6%81API"><span class="toc-number">12.</span> <span class="toc-text">Socket的重要API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Socket%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">12.1.</span> <span class="toc-text">Socket的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B"><span class="toc-number">12.2.</span> <span class="toc-text">类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">12.2.1.</span> <span class="toc-text">流套接字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">12.2.2.</span> <span class="toc-text">数据报套接字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">12.2.3.</span> <span class="toc-text">原始套接字</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B1%9E%E6%80%A7"><span class="toc-number">12.3.</span> <span class="toc-text">常用属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">12.4.</span> <span class="toc-text">常用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">12.4.1.</span> <span class="toc-text">常用于服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E8%AF%AD%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">12.4.2.</span> <span class="toc-text">常用语客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">12.4.3.</span> <span class="toc-text">常用于服务端和客户端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Socket%E5%A5%97%E6%8E%A5%E5%AD%97TCP%E9%80%9A%E4%BF%A1%E6%A6%82%E8%BF%B0"><span class="toc-number">13.</span> <span class="toc-text">Socket套接字TCP通信概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9C%80%E8%A6%81%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">13.1.</span> <span class="toc-text">服务端和客户端需要做什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-1"><span class="toc-number">13.1.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="toc-number">13.1.2.</span> <span class="toc-text">客户端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-2"><span class="toc-number">14.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-2"><span class="toc-number">15.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BB%BC%E5%90%88%E7%BB%83%E4%B9%A0"><span class="toc-number">16.</span> <span class="toc-text">服务端综合练习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ServerSocket-cs"><span class="toc-number">16.1.</span> <span class="toc-text">ServerSocket.cs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BB%BC%E5%90%88%E7%BB%83%E4%B9%A0"><span class="toc-number">17.</span> <span class="toc-text">客户端综合练习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8C%BA%E5%88%86%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"><span class="toc-number">18.</span> <span class="toc-text">区分消息类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8C%BA%E5%88%86%E6%B6%88%E6%81%AF"><span class="toc-number">18.1.</span> <span class="toc-text">如何区分消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NetManager"><span class="toc-number">18.1.1.</span> <span class="toc-text">NetManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClientSocket"><span class="toc-number">18.1.2.</span> <span class="toc-text">ClientSocket</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%8C%85%E3%80%81%E7%B2%98%E5%8C%85"><span class="toc-number">19.</span> <span class="toc-text">分包、粘包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%8C%85%E5%92%8C%E7%B2%98%E5%8C%85"><span class="toc-number">19.1.</span> <span class="toc-text">什么是分包和粘包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%88%86%E5%8C%85%E5%92%8C%E7%B2%98%E5%8C%85"><span class="toc-number">19.2.</span> <span class="toc-text">如何解决分包和粘包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%BB%E5%8A%A8%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5"><span class="toc-number">20.</span> <span class="toc-text">客户端主动断开连接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BF%83%E8%B7%B3%E6%B6%88%E6%81%AF"><span class="toc-number">21.</span> <span class="toc-text">实现心跳消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BF%83%E8%B7%B3%E6%B6%88%E6%81%AF"><span class="toc-number">21.1.</span> <span class="toc-text">什么是心跳消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%BF%83%E8%B7%B3%E6%B6%88%E6%81%AF"><span class="toc-number">21.2.</span> <span class="toc-text">为什么需要心跳消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BF%83%E8%B7%B3%E6%B6%88%E6%81%AF-1"><span class="toc-number">21.3.</span> <span class="toc-text">实现心跳消息</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/16/%E3%80%8A%E5%9F%8E%E5%B8%82%E5%8F%A0%E5%8F%A0%E4%B9%90%E3%80%8B%E4%B8%AD%E7%9A%84%E5%9F%8E%E5%B8%82%E6%98%AF%E6%80%8E%E4%B9%88%E6%90%AD%E8%B5%B7%E6%9D%A5%E7%9A%84%EF%BC%9F/" title="《城市叠叠乐》中的地图是怎么搭起来的？"><img src="/img/WFC.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《城市叠叠乐》中的地图是怎么搭起来的？"/></a><div class="content"><a class="title" href="/2024/06/16/%E3%80%8A%E5%9F%8E%E5%B8%82%E5%8F%A0%E5%8F%A0%E4%B9%90%E3%80%8B%E4%B8%AD%E7%9A%84%E5%9F%8E%E5%B8%82%E6%98%AF%E6%80%8E%E4%B9%88%E6%90%AD%E8%B5%B7%E6%9D%A5%E7%9A%84%EF%BC%9F/" title="《城市叠叠乐》中的地图是怎么搭起来的？">《城市叠叠乐》中的地图是怎么搭起来的？</a><time datetime="2024-06-16T14:17:32.179Z" title="更新于 2024-06-16 22:17:32">2024-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" title="Unity网络基础"><img src="/img/internet.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Unity网络基础"/></a><div class="content"><a class="title" href="/2024/04/07/Unity%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" title="Unity网络基础">Unity网络基础</a><time datetime="2024-04-22T14:41:08.306Z" title="更新于 2024-04-22 22:41:08">2024-04-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/17/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/" title="数据结构与算法学习笔记"><img src="/img/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法学习笔记"/></a><div class="content"><a class="title" href="/2023/08/17/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/" title="数据结构与算法学习笔记">数据结构与算法学习笔记</a><time datetime="2024-04-13T09:24:31.290Z" title="更新于 2024-04-13 17:24:31">2024-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/06/GAMES101%E7%8E%B0%E4%BB%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E5%85%A5%E9%97%A8/" title="GAMES101现代计算机图形学入门"><img src="/img/games101.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GAMES101现代计算机图形学入门"/></a><div class="content"><a class="title" href="/2023/04/06/GAMES101%E7%8E%B0%E4%BB%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E5%85%A5%E9%97%A8/" title="GAMES101现代计算机图形学入门">GAMES101现代计算机图形学入门</a><time datetime="2024-04-08T12:42:52.680Z" title="更新于 2024-04-08 20:42:52">2024-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/06/Unity%E4%B8%AD%E7%9A%84UI%E7%B3%BB%E7%BB%9F-UGUI/" title="Unity中的UI系统-UGUI"><img src="/img/ugui.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Unity中的UI系统-UGUI"/></a><div class="content"><a class="title" href="/2024/04/06/Unity%E4%B8%AD%E7%9A%84UI%E7%B3%BB%E7%BB%9F-UGUI/" title="Unity中的UI系统-UGUI">Unity中的UI系统-UGUI</a><time datetime="2024-04-07T03:30:12.231Z" title="更新于 2024-04-07 11:30:12">2024-04-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/internet.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By 紫地丁</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>